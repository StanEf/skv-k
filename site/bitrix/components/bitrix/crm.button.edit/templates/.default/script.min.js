var CrmButtonEditor=function(t){this.init=function(t){this.id=t.id;this.defaultWorkTime=t.defaultWorkTime;this.dictionaryTypes=t.dictionaryTypes;this.mess=t.mess;this.canRemoveCopyright=t.canRemoveCopyright||false;this.actionRequestUrl=t.actionRequestUrl;this.colorEditor=new CrmButtonEditColors({caller:this,context:BX("BUTTON_COLOR_CONTAINER")});this.widgetManager=new CrmButtonEditWidgetManager({caller:this,context:BX("WIDGET_CONTAINER"),dictionaryPathEdit:t.dictionaryPathEdit});this.locationManager=new CrmButtonEditLocation({caller:this,context:BX("LOCATION_CONTAINER")});this.locationManager=new CrmButtonEditButton({caller:this,context:BX("BUTTON_VIEW_CONTAINER")});this.hello=new CrmButtonEditHello({caller:this,context:BX("HELLO_CONTAINER")});this.initCopy();this.mainForm=BX("crm_button_main_form");this.subForm=BX("crm_button_sub_form");BX.bind(this.mainForm,"submit",BX.proxy(this.copySubFormDataToMainForm,this));this.initButtons();this.initToolTips();this.initLanguages();if(!this.canRemoveCopyright){BX.bind(BX("COPYRIGHT_REMOVED_CONT"),"click",BX.proxy(function(t){if(!B24||!B24["licenseInfoPopup"]){return}BX.PreventDefault(t);B24.licenseInfoPopup.show("crm_sitebutton_copyright",this.mess.dlgRemoveCopyrightTitle,"<span>"+this.mess.dlgRemoveCopyrightText+"</span>")},this))}};this.initButtons=function(){var t=this;var e=BX("BUTTON_COLOR_CONTAINER");this.loadedButtonCount=e.querySelectorAll("[data-b24-crm-button-widget]").length;this.blockNode=e.querySelector("[data-b24-crm-button-block]");this.blockInnerNode=e.querySelector("[data-b24-crm-button-block-inner]");BX.bind(this.blockNode,"mouseover",function(e){t.showButtons()});BX.bind(this.blockNode,"mouseout",function(e){t.hideButtons()})};this.initLanguages=function(){this.languageContext=BX("CRM_BUTTON_LANGUAGES");if(!this.languageContext){return}BX.bind(this.languageContext,"click",BX.proxy(this.openLanguagePopup,this))};this.openLanguagePopup=function(){var t=JSON.parse(this.languageContext.getAttribute("data-langs"));var e=[];var i=this;for(var o in t){(function(o){e.push({text:t[o],className:"language-icon "+o,onclick:function(e,a){this.close();i.changeLanguage(o,t[o])}})})(o)}BX.PopupMenu.show("crm-button-language-popup",this.languageContext,e,{offsetTop:10,offsetLeft:0})};this.changeLanguage=function(t,e){var i=this.languageContext.querySelector("[data-langs-input]");var o=this.languageContext.querySelector("[data-langs-text]");BX.removeClass(this.languageContext,i.value);BX.addClass(this.languageContext,t);i.value=t;o.innerText=e;o.title=e};this.showButtons=function(){BX.addClass(this.blockNode,"b24-crm-button-block-active");BX.addClass(this.blockNode,"b24-crm-button-block-active-"+this.loadedButtonCount);BX.removeClass(this.blockInnerNode,"b24-crm-button-animate-"+this.loadedButtonCount)};this.hideButtons=function(){BX.removeClass(this.blockNode,"b24-crm-button-block-active");BX.removeClass(this.blockNode,"b24-crm-button-block-active-"+this.loadedButtonCount);BX.addClass(this.blockInnerNode,"b24-crm-button-animate-"+this.loadedButtonCount)};this.copySubFormDataToMainForm=function(t){BX.convert.nodeListToArray(this.subForm.elements).forEach(function(t){var e=t.name;var i="";var o=this.mainForm.querySelector('[name="'+e+'"]');if(!o){o=document.createElement("INPUT");o.type="hidden";o.name=e;this.mainForm.appendChild(o)}switch(t.type){case"radio":case"checkbox":var a=this.subForm.querySelector('[name="'+e+'"]:checked');if(a){i=a.value}break;default:i=t.value}o.value=i},this);return true};this.initToolTips=function(t){t=t||document.body;this.popupTooltip={};var e=t.querySelectorAll(".crm-button-context-help");e=BX.convert.nodeListToArray(e);var i=this;for(var o=0;o<e.length;o++){if(e[o].getAttribute("context-help")=="y")continue;e[o].setAttribute("data-id",o);e[o].setAttribute("context-help","y");BX.bind(e[o],"mouseover",function(){var t=this.getAttribute("data-id");var e=this.getAttribute("data-text");i.showTooltip(t,this,e)});BX.bind(e[o],"mouseout",function(){var t=this.getAttribute("data-id");i.hideTooltip(t)})}};this.showTooltip=function(t,e,i){if(this.popupTooltip[t])this.popupTooltip[t].close();this.popupTooltip[t]=new BX.PopupWindow("bx-crm-site-button-tooltip",e,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[t].setAngle({offset:13,position:"bottom"});this.popupTooltip[t].show();return true};this.hideTooltip=function(t){this.popupTooltip[t].close();this.popupTooltip[t]=null};this.initCopy=function(){var t=BX("SCRIPT_CONTAINER");if(!t){return}var e="data-bx-webform-script-copy-btn";var i=t.querySelector("["+e+"]");var o=t.querySelector("[data-bx-webform-script-copy-text]");if(!i||!o){return}BX.clipboard.bindCopyClick(i,{text:o,offsetLeft:30})};this.appendTemplateNode=function(t,e,i){var o=this.getTemplateNode(t,i);if(!o){return null}e.appendChild(o);return o};this.getTemplateNode=function(t,e){var i=BX("template-crm-button-"+t);if(!i){return null}var o=document.createElement("div");var a=i.innerHTML;if(e){for(var n in e){a=a.replace(new RegExp("%"+n+"%","g"),e[n])}}o.innerHTML=a;o=o.children[0];return o};this.sendActionRequest=function(t,e,i,o){i=i||null;o=o||BX.proxy(this.showErrorPopup,this);e=e||{};var a=true;if(e instanceof FormData){e.append("action",t);e.append("button_id",this.id);e.append("sessid",BX.bitrix_sessid());a=false}else{e.action=t;e.button_id=this.id;e.sessid=BX.bitrix_sessid()}BX.ajax({url:this.actionRequestUrl,method:"POST",data:e,timeout:30,dataType:"json",processData:true,preparePost:a,onsuccess:BX.proxy(function(t){t=t||{};if(t.error){o.apply(this,[t])}else if(i){i.apply(this,[t])}},this),onfailure:BX.proxy(function(){var t={error:true,text:""};o.apply(this,[t])},this)})};this.showErrorPopup=function(t){t=t||{};var e=t.text||this.mess.errorAction;var i=BX.PopupWindowManager.create("crm_button_edit_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-button-edit-warning-popup-alert">'+e+"</span>");i.show()};this.init(t)};function CrmButtonEditActivationManager(t){this.attributeItem="data-bx-crm-button-item";this.attributeActive="data-bx-crm-button-item-active";this.attributeActiveValue="data-bx-crm-button-item-active-val";this.context=t.context;this.init()}CrmButtonEditActivationManager.prototype={init:function(){var t=this.context.querySelectorAll("["+this.attributeActive+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(t){BX.bind(t,"click",BX.delegate(function(){this.toggleActive(t)},this))},this)},toggleActive:function(t){var e="crm-button-edit-channel-lines-container-active";var i="crm-button-edit-channel-lines-title-on";var o="crm-button-edit-channel-lines-title-off";var a=t.getAttribute(this.attributeActive);var n=this.context.querySelector("["+this.attributeItem+'="'+a+'"]');var r=this.context.querySelector("["+this.attributeActiveValue+'="'+a+'"]');var s=BX.hasClass(t,i);if(s){BX.addClass(t,o);BX.removeClass(t,i);BX.removeClass(n,e);r.value="N"}else{BX.addClass(t,i);BX.removeClass(t,o);BX.addClass(n,e);r.value="Y"}}};function CrmButtonEditPageManager(t){this.attributePages="data-crm-button-pages";this.attributePagesList="data-crm-button-pages-list";this.attributePagesPage="data-crm-button-pages-page";this.attributePagesAdd="data-crm-button-pages-btn-add";this.attributePagesDel="data-crm-button-pages-btn-del";this.mainObject=t.mainObject;this.pageChangeHandler=t.pageChangeHandler}CrmButtonEditPageManager.prototype={initPages:function(t,e){var i=t.querySelectorAll("["+this.attributePagesList+"]");i=BX.convert.nodeListToArray(i);i.forEach(function(t){this.initPageButtons(t,e)},this)},initPageButtons:function(t,e){var i=t.querySelectorAll("["+this.attributePagesAdd+"]");i=BX.convert.nodeListToArray(i);i.forEach(function(t){BX.bind(t,"click",BX.delegate(function(){this.onClickPageButton(t,true,e)},this))},this);var o=t.querySelectorAll("["+this.attributePagesDel+"]");o=BX.convert.nodeListToArray(o);o.forEach(function(t){BX.bind(t,"click",BX.delegate(function(){this.onClickPageButton(t,false,e)},this))},this);var a=t.querySelectorAll("input");a=BX.convert.nodeListToArray(a);a.forEach(function(t){BX.bind(t,"blur",BX.delegate(function(){this.onPageChange()},this))},this)},onPageChange:function(){if(!this.pageChangeHandler){return}setTimeout(this.pageChangeHandler,400)},onClickPageButton:function(t,e,i){if(e){var o;var a=BX.findParent(t,{attribute:this.attributePages});var n=a.querySelector("script");if(n){o=document.createElement("div");o.innerHTML=n.innerHTML;o=o.children[0]}else{o=this.mainObject.getTemplateNode("page",i)}this.initPageButtons(o,i);var r=BX.findParent(t,{attribute:this.attributePagesList});r.appendChild(o)}else{var s=BX.findParent(t,{attribute:this.attributePagesPage});BX.remove(s)}this.onPageChange()}};function CrmButtonEditLocation(t){this.caller=t.caller;this.context=t.context;this.attributeItem="data-bx-crm-button-loc";this.attributeVal="data-bx-crm-button-loc-val";this.className="crm-button-edit-sidebar-button-position-block-active-";this.init()}CrmButtonEditLocation.prototype={init:function(){this.list=this.context.querySelectorAll("["+this.attributeItem+"]");this.list=BX.convert.nodeListToArray(this.list);this.list.forEach(function(t){BX.bind(t,"click",BX.delegate(function(){this.list.forEach(this.deactivate,this);this.activate(t)},this))},this)},deactivate:function(t){this.activate(t,true)},activate:function(t,e){e=e||false;var i=t.querySelector("["+this.attributeVal+"]");var o=i.value;if(e){BX.removeClass(t,this.className+o)}else{BX.addClass(t,this.className+o)}}};function CrmButtonEditColors(t){this.caller=t.caller;this.context=t.context;this.attributeBlock="data-b24-crm-button-block-button";this.attributeBlockBorder="data-b24-crm-button-block-border";this.attributePulse="data-b24-crm-button-pulse";this.attributeCont="data-b24-crm-button-block-inner";this.attributeIconItem="data-b24-crm-button-icon";this.classNameActive="b24-crm-button-inner-item-active";this.colorIconNode=BX("ICON_COLOR");this.colorBgNode=BX("BACKGROUND_COLOR");this.node=this.context.querySelector("["+this.attributeBlock+"]");this.previewNode=this.node.querySelector("["+this.attributeCont+"]");this.borderNode=this.context.querySelector("["+this.attributeBlockBorder+"]");this.pulseNode=this.context.querySelector("["+this.attributePulse+"]");var e=this.node.querySelectorAll("["+this.attributeIconItem+"]");e=BX.convert.nodeListToArray(e);this.previewItems=e.map(function(t){return{type:t.getAttribute(this.attributeIconItem),node:t,iconNode:t.querySelector("path")}},this);this.init()}CrmButtonEditColors.prototype={init:function(){this.initColorPicker()},changeActiveState:function(t,e){this.previewItems.forEach(function(i){if(i.type!=t){return}if(e){BX.addClass(i.node,this.classNameActive)}else{BX.removeClass(i.node,this.classNameActive)}},this);this.previewNode.style.background=this.colorBgNode.value;this.previewItems.forEach(function(t){t.iconNode.setAttribute("fill",this.colorIconNode.value)},this)},updateButtonColors:function(){var t=this.colorBgNode.value?this.colorBgNode.value:"#00AEEF";this.previewNode.style.background=t;this.borderNode.style.background=t;this.pulseNode.style.border="1px solid "+t;this.previewItems.forEach(function(t){t.iconNode.setAttribute("fill",this.colorIconNode.value?this.colorIconNode.value:"#FFFFFF")},this)},initColorPicker:function(){this.picker=new window.BXColorPicker({id:"picker",name:"picker"});this.picker.Create();var t=this;var e=function(){var e=this;e.parentNode.appendChild(t.picker.pCont);t.picker.oPar.OnSelect=BX.proxy(function(t){if(!t)t="";e.value=t;var i=BX.nextSibling(e);if(i){i.style.background=t}BX.fireEvent(e,"change")},t);t.picker.pCont.style.display="";t.picker.Close();t.picker.Open(e);t.picker.pCont.style.display="none"};var i=function(){var e=BX.nextSibling(this);if(e){e.style.background=this.value;t.updateButtonColors()}};var o=this.context.querySelectorAll("[data-web-form-color-picker]");o=BX.convert.nodeListToArray(o);for(var a in o){var n=o[a];var r=BX.nextSibling(n);BX.bind(r,"click",BX.proxy(e,n));BX.bind(n,"click",e);BX.bind(n,"focus",e);BX.bind(n,"bxchange",BX.delegate(i,n));BX.fireEvent(n,"change")}}};function CrmButtonEditWidgetManager(t){this.caller=t.caller;this.context=t.context;this.dictionaryPathEdit=t.dictionaryPathEdit;this.attributeSelect="data-bx-crm-button-widget-select";this.attributeButtonEdit="data-bx-crm-button-widget-btn-edit";this.attributeSettingsButton="data-crm-button-item-settings-btn";this.attributeSettings="data-crm-button-item-settings";this.attributeSettingsWTButton="data-crm-button-item-settings-wt-btn";this.attributeSettingsWTText="data-crm-button-item-settings-wt-txt";this.attributeSettingsWTDefText="data-crm-wt-def";this.attributeSettingsWT="data-crm-button-item-settings-wt";this.attributeWorkTime="data-crm-button-item-worktime";this.attributeWorkTimeButton="data-crm-button-item-worktime-btn";this.attributeWorkTimeActionRule="data-crm-button-item-worktime-action-rule";this.attributeWorkTimeActionText="data-crm-button-item-worktime-action-text";this.init()}CrmButtonEditWidgetManager.prototype={init:function(){this.pageManager=new CrmButtonEditPageManager({mainObject:this.caller});this.pageManager.initPages(this.context);this.initSelect();this.activationManager=new CrmButtonEditActivationManager({context:this.context});var t=this.context.querySelectorAll("["+this.attributeSettingsButton+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(t){BX.bind(t,"click",BX.proxy(function(){var e=t.getAttribute(this.attributeSettingsButton);var i=this.context.querySelector("["+this.attributeSettings+'="'+e+'"]');BX.toggleClass(i,"crm-button-edit-channel-lines-display-options-open")},this))},this);var e=this.context.querySelectorAll("["+this.attributeSettingsWTButton+"]");e=BX.convert.nodeListToArray(e);e.forEach(function(t){var e=t.getAttribute(this.attributeSettingsWTButton);var i=this.context.querySelector("["+this.attributeSettingsWT+'="'+e+'"]');BX.bind(t,"click",BX.proxy(function(){BX.toggleClass(i,"crm-button-edit-channel-lines-display-options-open")},this))},this);this.initWorkTime()},listenWorkTimeChanges:function(t,e){BX.bind(e,"change",BX.proxy(function(){this.changeWorkTimeLabel(t)},this))},changeWorkTimeLabel:function(t){var e=this.context.querySelector("["+this.attributeSettingsWT+'="'+t+'"]');var i=this.context.querySelector("["+this.attributeSettingsWTText+'="'+t+'"]');var o=i.getAttribute(this.attributeSettingsWTDefText);var a=e.querySelector("[data-crm-wt-enabled]");if(!a.checked){i.innerText=o}else{var n=e.querySelector("[data-crm-wt-time-from]");var r=e.querySelector("[data-crm-wt-time-to]");var s=e.querySelector("[data-crm-wt-days-caption]");var c=e.querySelectorAll("[data-crm-wt-days]:checked");c=BX.convert.nodeListToArray(c);var l=n.selectedOptions[0].textContent.trim();l+=" - "+r.selectedOptions[0].textContent.trim();if(c.length>0){l+=", "+s.textContent.toLowerCase()+": ";l+=c.map(function(t){return t.getAttribute("data-crm-wt-day-label")}).join(", ")}i.innerText=l}},initSelect:function(){var t=this.context.querySelectorAll("["+this.attributeSelect+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(t){BX.bind(t,"change",BX.proxy(function(){this.onChangeSelect(t)},this));this.onChangeSelect(t)},this)},onChangeSelect:function(t){var e=t.getAttribute(this.attributeSelect);var i=!!t.value;this.caller.colorEditor.changeActiveState(e,i);var o=this.context.querySelector("["+this.attributeButtonEdit+'="'+e+'"'+"]");if(i){var a=this.dictionaryPathEdit[e];o.href=a.path.replace(a.id,t.value)}o.style.display=i?"inline-block":"none";var n=null,r=null,s=null,c=null;if(this.caller.dictionaryTypes[e]){this.caller.dictionaryTypes[e].LIST.forEach(function(e){if(t.value==e.ID){n=e.WORK_TIME;r=e.CONNECTORS;s=e.PHONE_NAME;c=e.FORM_FIELDS}},this)}this.changeWorkTime(e,n);if(e=="openline"){var l=BX("openline_channels");l.innerHTML="";r.forEach(function(t){var e=document.createElement("span");e.title=t.name;BX.addClass(e,"crm-button-edit-channel-lines-social-items");BX.addClass(e,"connector-icon");BX.addClass(e,"connector-icon-"+t.code.replace(".","-"));l.appendChild(e)},this)}else if(e=="callback"){var u=BX("callback_phone_number");u.innerText=s}else if(e=="crmform"){var h=BX("crmform_fields");h.innerText=c.map(function(t){return t.CAPTION}).join(", ")}},initWorkTime:function(){var t=this.context.querySelectorAll("["+this.attributeWorkTimeButton+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(t){var e=t.getAttribute(this.attributeWorkTimeButton);var i=this.context.querySelector("["+this.attributeWorkTime+'="'+e+'"]');BX.bind(t,"change",BX.proxy(function(){var e=i.querySelector("[data-crm-wt-shadow]");e.style.display=t.checked?"none":""},this));var o=i.querySelector("[data-crm-wt-time-from]");var a=i.querySelector("[data-crm-wt-time-to]");var n=i.querySelectorAll("[data-crm-wt-days]");n=BX.convert.nodeListToArray(n);this.listenWorkTimeChanges(e,t);this.listenWorkTimeChanges(e,o);this.listenWorkTimeChanges(e,a);n.forEach(function(t){this.listenWorkTimeChanges(e,t)},this);this.changeWorkTimeLabel(e);var r=this.context.querySelector("["+this.attributeWorkTimeActionRule+'="'+e+'"]');BX.bind(r,"change",BX.proxy(function(){var t=this.context.querySelector("["+this.attributeWorkTimeActionText+'="'+e+'"]');t.style.display=r.value=="text"?"":"none"},this));BX.fireEvent(r,"change")},this)},changeWorkTime:function(t,e){var i="ITEMS["+t+"][WORK_TIME]";var o="ITEMS_"+t+"_WORK_TIME";var a=BX(o+"_"+"ENABLED");if(!a||a.checked){return}if(!e){e=this.caller.defaultWorkTime}BX(o+"_"+"TIME_ZONE").value=e.TIME_ZONE;BX(o+"_"+"TIME_FROM").value=e.TIME_FROM;BX(o+"_"+"TIME_TO").value=e.TIME_TO;BX(o+"_"+"HOLIDAYS").value=e.HOLIDAYS.join(",");var n=document.getElementsByName(i+"[DAY_OFF][]");n=BX.convert.nodeListToArray(n);n.forEach(function(t){t.checked=BX.util.in_array(t.value,e.DAY_OFF)})}};function CrmButtonEditAvatarEditor(t){this.caller=t.caller;this.context=t.context;this.init()}CrmButtonEditAvatarEditor.prototype={init:function(){this.editButtonNode=this.context.querySelector("[data-crm-button-edit-avatar-edit]");BX.bind(this.editButtonNode,"click",BX.delegate(this.show,this));this.avatarContainer=this.context.querySelector("[data-crm-button-edit-avatars]");this.attributeCarouselNext="data-crm-button-edit-avatar-next";this.attributeCarouselPrev="data-crm-button-edit-avatar-prev";this.attributeAvatar="data-crm-button-edit-avatar-edit";this.attributeAvatar="data-crm-button-edit-avatar-item";this.attributeAvatarRemove="data-remove";this.attributeFileId="data-file-id";this.attributePath="data-path";this.attributeView="data-view";this.getAllAvatarNodes().forEach(this.initAvatar,this);this.initCarousel()},createAvatarNode:function(t,e){var i=BX("crm_button_edit_template_avatar");i=i.innerHTML;t=BX.util.htmlspecialchars(t);e=BX.util.htmlspecialchars(e);i=i.replace("%file_id%",t).replace("%path%",e).replace("%path%",e);var o=BX.create("DIV");o.innerHTML=i;o=o.children[0];return o},initAvatar:function(t){var e=t.querySelector("["+this.attributeView+"]");e=e||t;BX.bind(e,"click",BX.delegate(function(){this.selectAvatar(t)},this));var i=t.getAttribute(this.attributeFileId);if(i){var o=t.querySelector("["+this.attributeAvatarRemove+"]");BX.bind(o,"click",BX.delegate(function(){this.removeFile(i,t)},this))}},selectAvatar:function(t){var e=t.getAttribute(this.attributePath);BX.onCustomEvent(this,"onSelect",[e])},initCarousel:function(){if(!this.carouselNextNode){this.carouselNextNode=this.context.querySelector("["+this.attributeCarouselNext+"]");this.carouselPrevNode=this.context.querySelector("["+this.attributeCarouselPrev+"]");BX.bind(this.carouselNextNode,"click",BX.delegate(function(){this.turnCarousel("next")},this));BX.bind(this.carouselPrevNode,"click",BX.delegate(function(){this.turnCarousel("prev")},this))}var t=this.getUserAvatarNodes();var e=Math.round(100/t.length);t.forEach(function(t){t.style.width=e+"%"},this);this.avatarContainer.style.width="calc(66px * "+t.length+")";this.turnCarousel("start")},turnCarousel:function(t){var e=this.getUserAvatarNodes();var i;var o=66;var a=-o*(e.length-3);var n=this.avatarContainer.style.left.toString();n=parseInt(n.replace("px",""));if(isNaN(n))n=0;switch(t){case"prev":i=n+o;break;case"start":i=0;break;case"end":i=1e5;break;case"next":default:i=n-o;break}if(i>=0){i=0}else if(i<a){i=a}this.carouselPrevNode.style.display=i==0||e.length<=3?"none":"";this.carouselNextNode.style.display=i==a||e.length<=3?"none":"";this.avatarContainer.style.left=i+(i==0?"":"px")},markCurrentAvatar:function(t){var e="selected";this.getAllAvatarNodes().forEach(function(i){var o=i.getAttribute(this.attributePath);if(o==t){BX.addClass(i,e)}else{BX.removeClass(i,e)}},this);this.getUserAvatarNodes().forEach(function(t,i){if(i>2&&BX.hasClass(t,e)){this.avatarContainer.insertBefore(t,this.avatarContainer.children[0])}},this)},getUserAvatarNodeByFileId:function(t){return this.avatarContainer.querySelector("["+this.attributeFileId+'="'+t+'"]')},getUserAvatarNodes:function(){return BX.convert.nodeListToArray(this.avatarContainer.querySelectorAll("["+this.attributeAvatar+"]"))},getAllAvatarNodes:function(){return BX.convert.nodeListToArray(this.context.querySelectorAll("["+this.attributeAvatar+"]"))},showLoader:function(){BX.addClass(this.editButtonNode,"loader")},hideLoader:function(){BX.removeClass(this.editButtonNode,"loader")},onFileAdded:function(t){var e=this.createAvatarNode(t.fileId,t.filePath);if(this.avatarContainer.children.length>0){this.avatarContainer.insertBefore(e,this.avatarContainer.children[0])}else{this.avatarContainer.appendChild(e)}this.initAvatar(e);this.initCarousel();this.selectAvatar(e);this.hideLoader()},onFileRemoved:function(t){if(t.fileId&&t.fileId>0){var e=this.getUserAvatarNodeByFileId(t.fileId)}if(t.error){this.caller.showErrorPopup(t);if(e){e.style.display=""}}else{BX.remove(e)}this.initCarousel();this.hideLoader()},addFile:function(t){if(!t||t.size<=0){return}this.showLoader();var e=new FormData;e.append("avatar_file",t);this.caller.sendActionRequest("addAvatarFile",e,BX.proxy(this.onFileAdded,this),BX.proxy(function(t){t=t||{error:true};this.onFileAdded(t)},this))},removeFile:function(t,e){this.showLoader();e.style.display="none";this.caller.sendActionRequest("removeAvatarFile",{fileId:t},BX.proxy(this.onFileRemoved,this))},show:function(){if(!this.editor){this.initEditor()}this.editor.show();BX.addCustomEvent(this.editor.popup,"onPopupClose",BX.proxy(this.onEditorPopupClose,this))},onEditorPopupClose:function(){BX.onCustomEvent(this,"onClose",[]);BX.removeCustomEvent(this.editor.popup,"onPopupClose",BX.proxy(this.onEditorPopupClose,this))},initEditor:function(){this.editor=new BX.AvatarEditor;BX.addCustomEvent(this.editor,"onApply",BX.delegate(function(t){if(!t){return}this.addFile(t)},this))}};function CrmButtonEditHello(t){this.caller=t.caller;this.context=t.context;this.blockCounter=1e3;this.init()}CrmButtonEditHello.prototype={init:function(){this.pageManager=new CrmButtonEditPageManager({mainObject:this.caller,pageChangeHandler:BX.proxy(this.onPagesChange,this)});this.activationManager=new CrmButtonEditActivationManager({context:this.context});this.customHelloContainer=BX("HELLO_MY_CONTAINER");this.defaultHelloContainer=BX("HELLO_ALL_CONTAINER");BX.bind(this.context.querySelector("[data-b24-crm-hello-add]"),"click",BX.proxy(this.addBlock,this));this.blockAttribute="data-b24-crm-hello-block";var t=this.customHelloContainer.querySelectorAll("["+this.blockAttribute+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(t){this.initBlock(t,true,false)},this);var e=this.defaultHelloContainer.querySelector("[data-b24-crm-hello-block]");this.initBlock(e,true,true);this.onPagesChange();this.modeSelector=this.context.querySelector("[data-b24-crm-hello-mode]");BX.bind(this.modeSelector,"click",BX.proxy(this.changeMode,this))},changeMode:function(){var t=this.modeSelector.value=="INCLUDE";BX("HELLO_ALL_CONTAINER").style.display=t?"none":""},addBlock:function(){var t={id:this.blockCounter++,target:"HELLO[CONDITIONS]",mode:"INCLUDE"};var e=this.caller.appendTemplateNode("hello",this.customHelloContainer,t);this.initBlock(e)},initBlock:function(t,e,i){e=e||false;i=i||false;if(!e){this.caller.initToolTips(t)}var o={target:"HELLO[CONDITIONS]",type:t.getAttribute(this.blockAttribute),mode:i?"EXCLUDE":"INCLUDE"};this.pageManager.initPageButtons(t,o);BX.bind(t.querySelector("[data-b24-hello-btn-remove]"),"click",BX.delegate(function(){this.removeBlock(t);this.onPagesChange()},this));var a="crm-button-edit-name-state";var n=t.querySelector("[data-b24-hello-name-text]");var r=t.querySelector("[data-b24-hello-name-input]");BX.bind(t.querySelector("[data-b24-hello-name-btn-edit]"),"click",BX.delegate(function(){BX.addClass(t,a)},this));BX.bind(t.querySelector("[data-b24-hello-name-btn-apply]"),"click",BX.delegate(function(){n.innerText=r.value.trim();BX.removeClass(t,a)},this));var s="crm-button-edit-description-state";var c=t.querySelector("[data-b24-hello-text-text]");var l=t.querySelector("[data-b24-hello-text-input]");BX.bind(t.querySelector("[data-b24-hello-text-btn-edit]"),"click",BX.delegate(function(){BX.addClass(t,s)},this));BX.bind(t.querySelector("[data-b24-hello-text-btn-apply]"),"click",BX.delegate(function(){c.innerText=l.value.trim();BX.removeClass(t,s)},this));var u=t.querySelector("[data-b24-hello-icon]");var h=t.querySelector("[data-b24-hello-icon-btn]");var d=t.querySelector("[data-b24-hello-icon-input]");var v=function(){this.currentIconNode=u;this.currentIconInputNode=d;this.showAvatarPopup()};BX.bind(u,"click",BX.delegate(v,this));BX.bind(h,"click",BX.delegate(v,this))},onSelectAvatar:function(t){if(t){this.currentIconNode.style["background-image"]="url("+t+")";this.currentIconInputNode.value=t}this.avatarPopup.close()},showAvatarPopup:function(){if(!this.avatarPopup){var t=BX("crm_button_edit_avatar_upload");this.avatarEditor=new CrmButtonEditAvatarEditor({caller:this.caller,context:t});BX.addCustomEvent(this.avatarEditor,"onClose",BX.delegate(this.showAvatarPopup,this));BX.addCustomEvent(this.avatarEditor,"onSelect",BX.delegate(this.onSelectAvatar,this));this.avatarPopup=BX.PopupWindowManager.create("crm_button_edit_avatar",null,{autoHide:true,lightShadow:true,overlay:true,closeIcon:true,closeByEsc:true,angle:true,content:t})}this.avatarEditor.markCurrentAvatar(this.currentIconInputNode.value);this.avatarPopup.setBindElement(this.currentIconNode);this.avatarPopup.show()},removeBlock:function(t){BX.remove(t)},onPagesChange:function(){var t=this.defaultHelloContainer.querySelector("[data-b24-hello-excluded-pages]");if(!t){return}var e=this.customHelloContainer.querySelectorAll("[data-crm-button-pages-list] input");e=BX.convert.nodeListToArray(e);var i=e.map(function(t){return t.value},this);t.innerText=i.filter(function(t){return!!t}).join("\n")}};function CrmButtonEditButton(t){this.caller=t.caller;this.context=t.context;this.container=this.context.querySelector("[data-b24-crm-button-cont]");this.attributeItem="data-bx-crm-button-item";this.init()}CrmButtonEditButton.prototype={init:function(){BX.addClass(this.context.querySelector("[data-b24-crm-button-pulse]"),"b24-widget-button-pulse-animate");this.animatedNodes=BX.convert.nodeListToArray(this.context.querySelectorAll("[data-b24-crm-button-icon]"));this.animate()},toggle:function(){var t="b24-widget-button-top";if(BX.hasClass(this.container,t)){BX.removeClass(this.container,t);this.shadow.hide()}else{BX.addClass(this.container,t);this.shadow.show()}},animate:function(){var t="b24-widget-button-icon-animation";var e=0;this.animatedNodes.forEach(function(i,o){if(BX.hasClass(i,t))e=o;BX.removeClass(i,t)},this);e++;e=e<this.animatedNodes.length?e:0;BX.addClass(this.animatedNodes[e],t);if(this.animatedNodes.length>1){var i=this;setTimeout(function(){i.animate()},1500)}},shadow:{init:function(t){this.c=t.caller;this.shadowNode=t.shadowNode;var e=this;BX.bind(this.shadowNode,"click",function(t){e.hide()});BX.bind(document,"keyup",function(t){t=t||window.e;if(t.keyCode==27){e.hide()}})},show:function(){BX.addClass(this.shadowNode,"b24-widget-button-shadow-show")},hide:function(){BX.removeClass(this.shadowNode,"b24-widget-button-shadow-show")}}};
//# sourceMappingURL=script.map.js